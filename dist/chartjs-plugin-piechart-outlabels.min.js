/*!
 * @energiency/chartjs-plugin-piechart-outlabels v1.3.2
 * http://www.chartjs.org
 * (c) 2017-2024 @energiency/chartjs-plugin-piechart-outlabels contributors
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ChartPieChartOutlabels=e(t.Chart,t.Chart.helpers)}(this,(function(t,e){"use strict";var i=function(){return i=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},i.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var r={PLUGIN_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:2,right:2,bottom:2,left:2},textAlign:"center",stretch:12,horizontalStrechPad:12,text:"%l %p",maxZoomOutPercentage:50,percentPrecision:1,valuePrecision:3},n=new WeakMap;function s(t){var e=n.get(t);return e||(e={sizeChanged:!1,fitting:!1},n.set(t,e)),e}var h=function(t,e){var i=(t.startAngle+t.endAngle)/2,r=Math.cos(i),n=Math.sin(i),s=t.outerRadius,h=s+e;return{x:t.x+r*h,y:t.y+n*h,d:h,arc:t,anchor:{x:t.x+r*s,y:t.y+n*s},copy:{x:t.x+r*h,y:t.y+n*h}}},a=function(t,e){var i=t.arc,r=t.d,n=(i.startAngle+i.endAngle)/2,s=Math.cos(n),h=Math.sin(n);return r+=e,{x:i.x+s*r,y:i.y+h*r,d:r,arc:i,anchor:t.anchor,copy:{x:i.x+s*r,y:i.y+h*r}}};function o(i,r){var n=e.valueOrDefault(i.size,t.Chart.defaults.font.size);i.resizable&&(n=function(t,e,i){var r=t/100*2.5;return e&&r<e?e:i&&r>i?i:r}(r,i.minSize,i.maxSize));var s={family:e.valueOrDefault(i.family,t.Chart.defaults.font.family),lineHeight:e.toLineHeight(i.lineHeight,n),size:n,style:e.valueOrDefault(i.style,t.Chart.defaults.font.style),weight:e.valueOrDefault(i.weight,null),string:""};return s.string=function(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}(s),s}var l=r.PLUGIN_KEY;var c=function(t,i,n,s,c){if(!e.resolve([s.display,!0],c,i))throw new Error("Label display property is set to false.");var d=c.dataset.data[i],u=c.labels[i],f=e.resolve([s.text,r.text],c,i);((f=f.replace(/%l/gi,u)).match(/%v\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%v\./gi,"");return e.length?+e:s.valuePrecision||r.valuePrecision})).forEach((function(t){f=f.replace(/%v\.?(\d*)/i,d.toFixed(t))})),(f.match(/%p\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:s.percentPrecision||r.percentPrecision})).forEach((function(t){f=f.replace(/%p\.?(\d*)/i,(100*c.percent).toFixed(t)+"%")}));for(var x=f.match(/[^\r\n]+/g)||[],g=0;g<x.length;++g)x[g]=x[g].trim();this.init=function(t,h){this.encodedText=s.text,this.text=t,this.lines=h,this.label=u,this.value=d,this.ctx=n,this.style={backgroundColor:e.resolve([s.backgroundColor,r.backgroundColor,"black"],c,i),borderColor:e.resolve([s.borderColor,r.borderColor,"black"],c,i),borderRadius:e.resolve([s.borderRadius,0],c,i),borderWidth:e.resolve([s.borderWidth,0],c,i),lineWidth:e.resolve([s.lineWidth,2],c,i),lineColor:e.resolve([s.lineColor,r.lineColor,"black"],c,i),color:e.resolve([s.color,"white"],c,i),font:o(e.resolve([s.font,{resizable:!0}]),n.canvas.style.height.slice(0,-2)),padding:e.toPadding(e.resolve([s.padding,0],c,i)),textAlign:e.resolve([s.textAlign,"left"],c,i)},this.stretch=e.resolve([s.stretch,r.stretch],c,i),this.horizontalStrechPad=e.resolve([s.horizontalStrechPad,r.horizontalStrechPad],c,i),this.size=function(t,e,i){var r,n=[].concat(e),s=n.length,h=0;for(t.save(),t.font=i.string,r=0;r<s;++r)h=Math.max(t.measureText(n[r]).width,h);return t.restore(),{height:s*("number"==typeof i.lineHeight?i.lineHeight:1),width:h}}(this.ctx,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0}},this.init(f,x),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth+this.style.padding.left+this.style.padding.right,e=this.textRect.height+2*this.style.borderWidth+this.style.padding.top+this.style.padding.bottom;return{x:this.textRect.x-this.style.borderWidth,y:this.textRect.y-this.style.borderWidth,width:t,height:e,isLeft:this.textRect.isLeft,isTop:this.textRect.isTop}},this.computeTextRect=function(){var t=this.center.x-this.center.anchor.x<0,e=this.center.y-this.center.anchor.y<0,i=t?-(this.horizontalStrechPad+this.size.width):this.horizontalStrechPad;return{x:this.center.x-this.style.padding.left+i,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height,isLeft:t,isTop:e}},this.drawText=function(){var t,e,i,r=this.style.textAlign,n=this.style.font.lineHeight,s=this.style.color,h=this.lines.length;if(h&&s)for(t=this.textRect.x,e=this.textRect.y+n/2,"center"===r?t+=this.textRect.width/2:"end"!==r&&"right"!==r||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=s,this.ctx.textAlign=r,this.ctx.textBaseline="middle",i=0;i<h;++i)this.ctx.fillText(this.lines[i],Math.round(t)+this.style.padding.left,Math.round(e),Math.round(this.textRect.width)),e+=n},this.ccw=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},this.intersects=function(t,e,i,r){return this.ccw(t,i,r)!==this.ccw(e,i,r)&&this.ccw(t,e,i)!==this.ccw(t,e,r)},this.drawLine=function(){if(this.lines.length){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.center.copy.x,this.center.copy.y);var t=this.textRect.width+this.style.padding.width,e=this.intersects(this.textRect,{x:this.textRect.x+this.textRect.width,y:this.textRect.y+this.textRect.height},this.center.copy,{x:this.textRect.x,y:this.textRect.y+this.textRect.height/2});this.ctx.lineTo(this.textRect.x+(e?t:0),this.textRect.y+this.textRect.height/2),this.ctx.stroke(),this.ctx.restore()}},this.draw=function(){t.getDataVisibility(i)&&(this.drawText(),this.drawLine())},this.update=function(e,r,n){this.center=h(e,this.stretch);for(var s,o,c=!1,d=30;!c&&d>0;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect(),c=!0;for(var u=0;u<n;++u){var f=r[u][l];if(f&&t.getDataVisibility(i)&&(s=this.labelRect,o=f.labelRect,s.x<o.x+o.width&&s.x+s.width>o.x&&s.y<o.y+o.height&&s.y+s.height>o.y)){c=!1;break}}c||(this.center=a(this.center,5)),d--}}};t.defaults.plugins.outlabels=r;var d=r.PLUGIN_KEY;function u(t,e){var i=e.width,r=e.height,n=[(e.left-t.left)/i*2,(e.top-t.top)/r*2,(t.right-e.right)/i*2,(t.bottom-e.bottom)/r*2],s=Math.max.apply(Math,function(t,e,i){if(i||2===arguments.length)for(var r,n=0,s=e.length;n<s;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}([0],n,!1));return 1-s}function f(t){for(var e=0,i=t.length;e<i;e++){var r=t[e],n=r[d];n&&n.update(r,t,e)}}function x(t){var e=t._metasets[0].controller,r=e.getMeta(),n=function(t){for(var e={left:1/0,right:-1/0,top:1/0,bottom:-1/0},r=0,n=t.length;r<n;r++){var s=t[r][d];if(s&&s.labelRect){var h=s.labelRect,a=h.x,o=h.y,l=h.width,c=h.height;e.left=Math.min(e.left,a),e.right=Math.max(e.right,a+l),e.top=Math.min(e.top,o),e.bottom=Math.max(e.bottom,o+c)}}return i(i({},e),{width:e.right-e.left,height:e.bottom-e.top})}(r.data||[]),s=u(n,t.chartArea);return!(!s||1===s)&&(e.outerRadius=e.outerRadius*s,e.innerRadius*=s,e.updateElements(r.data,0,r.data.length,"none"),!0)}return{id:"outlabels",resize:function(t){s(t).sizeChanged=!0},afterUpdate:function(t){var e=t._metasets[0].controller.getMeta().data||[],i=!1,r=e.length;for(s(t).fitting=!0;!i&&r-- >0;)f(e),i=!x(t);s(t).fitting=!1},afterDatasetUpdate:function(t,e,i){var r,n,h,a,o,l,u=t.config.data.labels,f=t.data.datasets[e.index],x=function(t,e){var i=t.outlabels;return!1===i?null:(!0===i&&(i={}),Object.assign({},{},e,i))}(f,i),g=x&&x.display,y=e.meta.data||[],p=t.ctx;for(p.save(),l=0;l<y.length;++l){if(n=(r=y[l])[d],h=f.data[l]/e.meta.total,a=null,g&&r&&!r.hidden)try{o={chart:t,dataIndex:l,dataset:f,labels:u,datasetIndex:e.index,percent:h},a=new c(t,l,p,x,o)}catch(t){a=null}n&&a&&!s(t).sizeChanged&&n.label===a.label&&n.encodedText===a.encodedText&&(a.offset=n.offset),r[d]=a}p.restore(),s(t).sizeChanged=!1},afterDatasetDraw:function(t,e){var i=e.meta.data||[],r=t.ctx;s(t).fitting||i.forEach((function(t,e){var n=t[d];n&&(n.update(t,i,e),n.draw(r))}))},afterDestroy:function(t){!function(t){n.delete(t)}(t)}}}));
